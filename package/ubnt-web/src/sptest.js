var ticket=0;var max_time=0;var old_tx=0;var old_rx=0;var old_time=0;var old_mtime=0;function init(){loadIPs();onAdvancedChanged()}var ip_regex=/^((25[0-5]|2[0-4]\d|[01]\d\d|\d?\d)\.){3}(25[0-5]|2[0-4]\d|[01]\d\d|\d?\d)$/;function validateInput(){var a=true;$("#results").html("");if($("#dst_addr_select").val()=="0"){var b=$("#dst_addr_input").val();a=ip_regex.exec(b)!=null&&b!="0.0.0.0";if(!a){$("#results").append(jsTranslate("IP address is invalid.")+"<br/>")}}if($("#show_adv").is(":checked")){var c=parseInt($("#time_limit").val());if(isNaN(c)||c<=0||c>99){a=false;$("#results").append(jsTranslate("Duration is invalid.")+" [1-99]<br/>")}}if($("#auth_user").val().length==0||$("#auth_password").val().length==0){a=false;$("#results").append(jsTranslate("User/password cannot be empty.")+"<br/>")}return a}function getRemoteIp(){return $("#dst_addr_select").val()=="0"?$("#dst_addr_input").val():$("#dst_addr_select option:selected").text()}var timeoutCount=0;function getResultsRequest(a){if(timeoutCount>Math.ceil(max_time/10+3)){$("#results").html(jsTranslate("Error")+": "+jsTranslate("Speedtest timed out."));enableForm(true);$("#loader").hide();sendStopRequest();return}setTimeout(function(){var b={};b.ticket=ticket;b.action="status";$.ajax({url:"sptest_action.cgi",cache:false,data:b,dataType:"json",success:handleStatus,timeout:10000,error:function(f,g,e){if(g=="OK"){try{d=$.parseJSON(f.responseText);handleStatus(d,g)}catch(c){getResultsRequest(100)}}else{if(g=="timeout"){timeoutCount++;getResultsRequest(100)}else{getResultsRequest(100)}}}})},a)}function unknownError(a){handleError(a,jsTranslate("Error occurred. Please try again."),"")}function sendStopRequest(){var a={};a.ticket=ticket;a.action="stop";$.ajax({url:"sptest_action.cgi",cache:false,data:a,dataType:"json",success:function(){}})}function handle_overwrap(c,b,a){if(c<b){$("#results").html("Wrap "+b+"->"+c);if(b>2147483647/a){return 4294967295/a-b+c}else{if((c+b)<(2415919103/a)){return c}else{return 2147483647/a-b+c}}}return c-b}function handleStatus(g,b){var e=(g.state==10);var h=true;var f=g.microtime.split(" ",2);var c=0;f[0]=parseFloat(f[0]);f[1]=parseInt(f[1]);if(old_tx==0&&old_rx==0){old_tx=g.tx;old_rx=g.rx;old_mtime=f[0];old_time=f[1];h=e}else{c=handle_overwrap(f[1],old_time,1)+f[0]-old_mtime}if(g.flags==0&&h){var k=$("#direction_select").val();var j=0;var a=0;var l=0;if(e){j=toFixed(g.tx,2);a=toFixed(g.rx,2)}else{j=toFixed(handle_overwrap(g.tx,old_tx,131072)/c,2);a=toFixed(handle_overwrap(g.rx,old_rx,131072)/c,2)}switch(k){case"tx":$("#tx_results").html(j+" Mbps");$("#rx_results").html("0.00 Mbps");l=j;break;case"rx":$("#tx_results").html("0.00 Mbps");$("#rx_results").html(a+" Mbps");l=a;break;default:$("#tx_results").html(j+" Mbps");$("#rx_results").html(a+" Mbps");l=toFixed(parseFloat(j)+parseFloat(a),2);break}$("#total_results").html(l+" Mbps");$("#results").html("")}if(e||c>max_time||g.flags!=0){if(!e){$("#results").html(jsTranslate("Error")+": "+jsTranslate("Speedtest timed out."))}enableForm(true);$("#loader").hide();sendStopRequest()}else{getResultsRequest(100)}}function handleStart(a,b){if(a.status!=0){$("#results").html(jsTranslate("Error")+":>: "+a.message);enableForm(true);$("#loader").hide();return}$("#results").html("");$("#loader").show();old_tx=0;old_rx=0;old_time=0;max_time=parseInt($("#time_limit").val())+5;timeoutCount=0;setTimeout(function(){getResultsRequest(1,max_time*1000)},1100)}function handleRemote(a,f){if(a==null){window.location.reload()}if(a.status!=0){$("#results").html(jsTranslate("Error")+":<: "+a.message);enableForm(true);return}var e={};e.ticket=ticket;e.action="start";e.target=getRemoteIp();e.port=$("#launcher_port").val();e.login=$("#auth_user").val();e.passwd=$("#auth_password").val();e.duration=30;e.direction="dx";if($("#show_adv").is(":checked")){var c=$("#time_limit").val();if(c<0||c>99){c=30}e.duration=c;var b=$("#direction_select").val();e.direction=b}$.ajax({cache:false,url:"sptest_action.cgi",data:e,dataType:"json",success:handleStart,error:handleError})}function startTest(){if(!validateInput()){return}var a=function(){var e="";for(var c=0;c<8;++c){e+=(((1+Math.random())*65536)|0).toString(16).substring(1)}return e};ticket=Math.floor(Math.random()*1000);$("#results").html(jsTranslate("Processing")+"...");$("#tx_results").html("N/A");$("#rx_results").html("N/A");$("#total_results").html("N/A");enableForm(false);var b={};b.ticket=ticket;b.action="remote";b.target=getRemoteIp();b.port=$("#launcher_port").val();b.login=$("#auth_user").val();b.passwd=$("#auth_password").val();b.airosid=a();$.ajax({cache:false,url:"sptest_action.cgi",data:b,dataType:"json",success:handleRemote,error:handleError})}function handleError(b,c,a){if(c==="timeout"){c=jsTranslate("Connection lost. Please try again.")}enableForm(true);$("#loader").hide();if(b&&b.status!=200&&b.status!=0){window.location.reload()}else{$("#results").html(jsTranslate("Error")+": "+c)}}function enableForm(a){$("#runtest").enable(a);set_controls(a)}function refreshIPs(c){var a='<option value="0">'+jsTranslate("specify manually")+"</option>";var b=c.split("\n");for(i=0;i<b.length;++i){if(b[i].length>0){a+='<option value="'+i+1+'">';a+=b[i]+"</option>"}}$("#dst_addr_select").html(a);onIpChanged()}$.fn.set_visible=function(a){if(a){return this.show()}else{return this.hide()}};function onIpChanged(){$("#dst_addr_input").enable($("#dst_addr_select").val()==0)}function onAdvancedChanged(){var a=$("#show_adv").is(":checked");$("#advanced1").set_visible(a);$("#advanced2").set_visible(a)}function loadIPs(){$.post("ipscan.cgi?a="+new Date().getTime(),refreshIPs)}function set_controls(a){a=!a;document.getElementById("dst_addr_select").disabled=a;document.getElementById("ip_refresh").disabled=a;document.getElementById("dst_addr_input").disabled=a;document.getElementById("auth_user").disabled=a;document.getElementById("auth_password").disabled=a;document.getElementById("launcher_port").disabled=a;document.getElementById("show_adv").disabled=a;document.getElementById("direction_select").disabled=a;document.getElementById("time_limit").disabled=a}$(document).ready(function(){$("#runtest").click(function(){startTest();return false});$("#ip_refresh").click(function(){loadIPs();return false});$("#dst_addr_select").change(onIpChanged);$("#show_adv").change(onAdvancedChanged);init()});