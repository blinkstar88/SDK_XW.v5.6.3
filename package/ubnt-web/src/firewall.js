var Firewall=new function(){this.isProtoIp6=function(a){var b=a.toLowerCase();return b=="0x86dd"||b=="ipv6"};this.createRule=function(b,a,d){var c=b.objPrototypes.createNewObj(a,{_chain:this.isProtoIp6(d.proto)?"FIREWALL6":"FIREWALL",_proto:d.proto,_devname:d.devname,_ipProto:d.ipProto,_src:d.src,_sport:(d.ipProto!=0?d.sport:""),_dst:d.dst,_dport:(d.ipProto!=0?d.dport:""),_target:d.target,_src_inv:(d.src.length>0?d.src_inv:false),_sport_inv:(d.ipProto!=0&&d.sport?d.sport_inv:false),_dst_inv:(d.dst.length>0?d.dst_inv:false),_dport_inv:(d.ipProto!=0&&d.dport?d.dport_inv:false),comment:d.comment,status:d.enabled?"enabled":"disabled"});c.cmd=c.buildCmd();return c};this.addRule=function(b,a){b.push(a);return a};this.removeRule=function(c,b){var a=$.inArray(b,c);if(a!=-1){c.splice(a,1)}};this.replaceRule=function(c,d,b){var a=typeof d==="number"?d:$.inArray(d,c);if(a!=-1){c[a]=b}};this.serializeRule=function(a,b,c){a.push(b+"status="+c.status);a.push(b+"cmd="+c.cmd);a.push(b+"comment="+c.comment)};this.validateRule=function(b,c){var a=c||[];if(!this.isProtoIp6(b._proto)){if(!this.validateIp(b._src)){a.push(jsTranslate("Source IP/Mask is invalid."))}if(!this.validateIp(b._dst)){a.push(jsTranslate("Destination IP/Mask is invalid."))}}else{if(!this.validateIp6(b._src)){a.push(jsTranslate("Source IP/Mask is invalid."))}if(!this.validateIp6(b._dst)){a.push(jsTranslate("Destination IP/Mask is invalid."))}}if(!this.validatePort(b._sport)){a.push(jsTranslate("Source port is invalid."))}if(!this.validatePort(b._dport)){a.push(jsTranslate("Destination port is invalid."))}return(a.length==0)};this.validateIp=function(b){b=b.replace(/^\s+|\s+$/g,"");if(!b.length||b=="0.0.0.0/0"){return true}if((pos=b.indexOf("/"))>=0){var a=b.substr(pos+1);if(isNaN(a)||parseInt(a)!=a||parseInt(a)<0||parseInt(a)>32){return false}b=b.substr(0,pos)}return _validateIP(b)};this.validateIp6=function(b){b=b.replace(/^\s+|\s+$/g,"");if(!b.length){return true}if((pos=b.indexOf("/"))>=0){var a=b.substr(pos+1);if(isNaN(a)||parseInt(a)!=a||parseInt(a)<0||parseInt(a)>128){return false}b=b.substr(0,pos)}return _validateIP6(b)};this.validatePort=function(c){c=c.replace(/^\s+|\s+$/g,"");if(!c.length){return true}if((pos=c.indexOf(":"))>=0){var e=c.substr(0,pos);var d=c.substr(pos+1);if(isNaN(e)||isNaN(d)){return false}var b=parseInt(e);var a=parseInt(d);if(b!=e||a!=d||b<1||b>65535||a<1||a>65535||b>a){return false}}else{if(isNaN(c)||parseInt(c)!=c||parseInt(c)<1||parseInt(c)>65535){return false}}return true};this.protoStr=function(a){switch(a){case"1":return"ICMP";case"6":return"TCP";case"17":return"UDP";case"58":return"ICMP";case"p2p":return"P2P";default:return"IP"}};this.initRule=function(b){if(!b||!b.cmd||b.cmd.replace(/^\s+|\s+$/g,"").length==0){return false}var c=$.grep(b.cmd.split(" "),function(d){return d.length});for(var a=0;a<c.length-1;++a){switch(c[a]){case"-t":b._table=c[++a];break;case"-A":b._chain=c[++a];break;case"-p":b._proto=c[++a];break;case"-i":b._devname=c[++a];break;case"-m":if(c[++a]=="ipp2p"){b._ipProto="p2p"}break;case"--protocol":case"--ip-protocol":case"--ip6-protocol":b._ipProto=c[++a];break;case"--src":case"--ip-src":case"--ip6-src":if(c[++a]=="!"&&(a+1)<c.length&&a++){b._src_inv=true}b._src=c[a];break;case"--sport":case"--ip-sport":case"--ip6-sport":if(c[++a]=="!"&&(a+1)<c.length&&a++){b._sport_inv=true}b._sport=c[a];break;case"--dst":case"--ip-dst":case"--ip6-dst":if(c[++a]=="!"&&(a+1)<c.length&&a++){b._dst_inv=true}b._dst=c[a];break;case"--dport":case"--ip-dport":case"--ip6-dport":if(c[++a]=="!"&&(a+1)<c.length&&a++){b._dport_inv=true}b._dport=c[a];break;case"--vlan-id":b._vlan=c[++a];break;case"-j":b._target=c[++a];break}if(!b._proto&&b._chain=="FIREWALL6"){b._proto="0x86dd"}}return true};this.buildIpCmd=function(b){var a=[];if(b._table&&b._table.length){a.push("-t "+b._table)}a.push("-A "+b._chain);if(b._devname.length>0){a.push("-i "+b._devname)}if(b._ipProto!=0){if(b._ipProto=="p2p"){a.push("-m ipp2p --ipp2p")}else{a.push("--protocol "+b._ipProto)}}if(b._src.length>0){a.push("--src "+(!b._src_inv?"":"! ")+b._src)}if(b._ipProto!=0&&b._sport.length>0){a.push("--sport "+(!b._sport_inv?"":"! ")+b._sport)}if(b._dst.length>0){a.push("--dst "+(!b._dst_inv?"":"! ")+b._dst)}if(b._ipProto!=0&&b._dport.length>0){a.push("--dport "+(!b._dport_inv?"":"! ")+b._dport)}a.push("-j "+(b._target.length>0?b._target:"DROP"));return a.join(" ")};this.buildEbCmd=function(b){var a=[];if(b._table&&b._table.length){a.push("-t "+b._table)}a.push("-A "+b._chain);if(b._devname.length>0){a.push("-i "+b._devname)}a.push("-p "+b._proto);switch(b._proto.toLowerCase()){case"0x0800":case"ipv4":if(b._ipProto!=0){a.push("--ip-protocol "+b._ipProto)}if(b._src.length>0){a.push("--ip-src "+(!b._src_inv?"":"! ")+b._src)}if(b._ipProto!=0&&b._sport.length>0){a.push("--ip-sport "+(!b._sport_inv?"":"! ")+b._sport)}if(b._dst.length>0){a.push("--ip-dst "+(!b._dst_inv?"":"! ")+b._dst)}if(b._ipProto!=0&&b._dport.length>0){a.push("--ip-dport "+(!b._dport_inv?"":"! ")+b._dport)}break;case"0x8100":if(b._vlan.length){a.push("--vlan-id "+b._vlan)}break;case"0x86dd":case"ipv6":if(b._ipProto!=0){a.push("--ip6-protocol "+b._ipProto)}if(b._src.length>0){a.push("--ip6-src "+(!b._src_inv?"":"! ")+b._src)}if(b._ipProto!=0&&b._sport.length>0){a.push("--ip6-sport "+(!b._sport_inv?"":"! ")+b._sport)}if(b._dst.length>0){a.push("--ip6-dst "+(!b._dst_inv?"":"! ")+b._dst)}if(b._ipProto!=0&&b._dport.length>0){a.push("--ip6-dport "+(!b._dport_inv?"":"! ")+b._dport)}break}a.push("-j "+(b._target.length>0?b._target:"DROP"));return a.join(" ")}};