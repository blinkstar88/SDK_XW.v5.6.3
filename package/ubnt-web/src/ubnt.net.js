(function(){var b=this.ubnt||(this.ubnt={}),a=b.net||(b.net={});a.network=function(f){var c=function(j){return{netconfObj:j,enabled:function(){if(arguments[0]!==undefined){this.netconfObj.enabled(arguments[0])}return this.netconfObj.enabled()},getDevname:function(){return this.netconfObj.getDevname()},getNatDevname:function(){return this.ipMode==="Pppoe"?"ppp+":j.devname},setDevname:function(k){this.netconfObj.devname=k;if(this.dhcpcObj){this.dhcpcObj.devname=k}if(this.pdObj){this.pdObj.devname=k}if(this.pppObj){this.pppObj.devname=k}if(this.dhcpdObj){this.dhcpdObj.devname=k}if(this.dhcp6dObj){this.dhcp6dObj.devname=k}if(this.dhcpRelayClientObj){this.dhcpRelayClientObj.devname=k}this.updateNatDevname()},updateNatDevname:function(){var k=this.getNatDevname();if(this.masqObj){this.masqObj.devname=k}if(this.dmzObj){this.dmzObj.devname=k}if(this.mgmtObj){this.mgmtObj.devname=k}if(this.dhcp6cObj){this.dhcp6cObj.devname=k}},getIpMode:function(){var l=f.get("dhcpc"),k=f.get("ppp");if(!this.dhcpcObj){this.dhcpcObj=l.findByDevname(j.devname)}if(!this.pppObj){this.pppObj=k.findByDevname(j.devname)}this.ipMode="Static";if(l.enabled()&&this.dhcpcObj&&this.dhcpcObj.enabled()){this.ipMode="Dhcpc"}else{if(k.enabled()&&this.pppObj&&this.pppObj.enabled()){this.ipMode="Pppoe"}}return this.ipMode},setIpMode:function(o,k){var n=f.get("iptables.sys.tcpmss",false);this.ipMode=o;switch(o){case"Static":if(this.dhcpcObj!==undefined&&this.dhcpcObj.enabled()){this.dhcpcObj.enabled(false)}if(this.pppObj!==undefined&&this.pppObj.enabled()){this.pppObj.enabled(false);f.get("ppp").enabled(false)}if(n){n.enabled(false)}break;case"Dhcpc":var m=f.get("dhcpc");m.enabled(true);if(this.dhcpcObj===undefined){var q=m.find({devname:j.devname});if(q.length>0){this.dhcpcObj=q[0];this.dhcpcObj.devname=j.devname}else{this.dhcpcObj=m.create(j.devname,"192.168.1.20","255.255.255.0",true);m.add(this.dhcpcObj)}}this.dhcpcObj.enabled(true);this.netconfObj.ip="0.0.0.0";if(this.pppObj!==undefined&&this.pppObj.enabled()){this.pppObj.enabled(false);f.get("ppp").enabled(false)}if(k===true){f.get("route.1").enabled(false)}if(n){n.enabled(false)}break;case"Pppoe":var l=f.get("ppp");l.enabled(true);if(this.pppObj===undefined){var p=l.find({});if(p.length>0){this.pppObj=p[0];this.pppObj.devname=j.devname}else{this.pppObj=l.create(j.devname,"","","",false,1492,1492,true);l.add(this.pppObj)}}else{this.pppObj.enabled(true)}f.get("iptables.sys.tcpmss").enabled(true);j.ip="0.0.0.0";j.netmask="255.255.255.255";if(this.dhcpcObj!==undefined&&this.dhcpcObj.enabled()){this.dhcpcObj.enabled(false)}if(k===true){f.get("route.1").enabled(false)}break}this.updateNatDevname()},getIp6Mode:function(){var k=this.netconfObj.ip6,m=f.get("dhcp6c");var l=this.getNatDevname();if(!this.dhcp6cObj){this.dhcp6cObj=m.findByDevname(l)}this.ip6Mode="Ip6Static";if(m.enabled()&&this.dhcp6cObj&&this.dhcp6cObj.enabled()){if(this.dhcp6cObj.stateful&&this.dhcp6cObj.stateful.enabled()){this.ip6Mode="Ip6Dhcp6"}else{this.ip6Mode="Ip6Slaac"}}else{if(!(k&&k.objs.length&&k.objs[0]&&k.objs[0].addr)){this.ip6Mode="Ip6Slaac"}}return this.ip6Mode},setIp6Mode:function(n){var k=this.netconfObj.ip6;this.ip6Mode=n;switch(n){case"Ip6Static":if(this.dhcp6cObj!==undefined&&this.dhcp6cObj.enabled()){this.dhcp6cObj.enabled(false)}break;case"Ip6Slaac":case"Ip6Dhcp6":var m=f.get("dhcp6c");m.enabled(true);if(this.dhcp6cObj===undefined){var l=m.find({devname:this.getNatDevname()});if(l.length>0){this.dhcp6cObj=l[0];this.dhcp6cObj.devname=j.devname}else{this.dhcp6cObj=m.create(j.devname,true);m.add(this.dhcp6cObj)}}this.dhcp6cObj.enabled(true);this.dhcp6cObj.stateless.enabled(n==="Ip6Slaac");this.dhcp6cObj.stateful.enabled(n==="Ip6Dhcp6");if(k&&k.objs[0]&&k.objs[0].enabled()){k.objs[0].enabled(false)}f.get("route6.1").enabled(false);break}},getLanIp6Mode:function(k){var l="Static";if(k&&k.enabled()&&k.stateful&&k.stateful.enabled()&&k.stateful.pd){this.pdObj=k.stateful.pd.findByDevname(this.getDevname());if(this.pdObj.enabled()){return"PD"}}return l},setLanIp6Mode:function(p,q,n){var m=this.netconfObj.ip6;var o=m.objs[0];if(o){o.enabled(q==="Static")}if(q==="Static"){if(this.pdObj&&this.pdObj.enabled()){this.pdObj.enabled(false)}}else{if(q==="PD"){if(!this.pdObj){var l=p.stateful;var k=l.pd||(l.pd=b.cfg.objPrototypes.createNewObj("pd"));this.pdObj=k.create(this.getDevname());k.add(this.pdObj)}this.pdObj.prefix={len:n};this.pdObj.enabled(true)}}},setIp6PrefixLen:function(k){if(!this.pdObj.prefix){this.pdObj.prefix={}}this.pdObj.prefix.len=k},getIp6PrefixLen:function(){return this.pdObj&&this.pdObj.prefix&&this.pdObj.prefix.len?this.pdObj.prefix.len:"64"},setIp:function(l,k){this.netconfObj.ip=l;this.netconfObj.netmask=k},getGateway:function(){var l="",k=f.get("route.1");if(k.ip==="0.0.0.0"){l=k.gateway}return l},setGateway:function(m){var l=f.get("route"),k=f.route.create("0.0.0.0","0",m,"",true);k.devname=this.netconfObj.devname;l.replace(0,k);l.enabled(true)},getIp6Gateway:function(){var l="",k=f.get("route6.1");if(k.ip==="::"){l=k.gateway}return l},setIp6Gateway:function(m){var l=f.get("route6"),k=l.create("::","0",m,"",true);k.devname=this.netconfObj.devname;l.replace(0,k);l.enabled(true)},getDns:function(k){return f.get("resolv.nameserver."+(k+1)).ip},setDns:function(l,m){var n=f.get("resolv.nameserver"),k=n.create(m,m.length>0);n.replace(l,k);n.enabled(true)},getDhcpcFallback:function(){return this.dhcpcObj&&this.dhcpcObj.fallback?this.dhcpcObj.fallback:(f.netmode=="bridge"?"192.168.1.20":"192.168.10.1")},getDhcpcFallbackNetmask:function(){return this.dhcpcObj&&this.dhcpcObj.fallback_netmask?this.dhcpcObj.fallback_netmask:"255.255.255.0"},setDhcpcFallback:function(l,k){this.dhcpcObj.fallback=l;this.dhcpcObj.fallback_netmask=k},getPppoe:function(k){if(this.pppObj&&this.pppObj[k]){return this.pppObj[k]}else{return{fallback:"192.168.10.1",fallback_netmask:"255.255.255.0",mtu:1492,mru:1492}[k]}},setPppoe:function(k){$.extend(this.pppObj,k)},natEnabled:function(){var l=f.get("iptables.sys.masq");if(!this.masqObj){this.masqObj=l.findByDevname(this.getNatDevname())}if(arguments[0]!==undefined){if(this.masqObj){this.masqObj.enabled(arguments[0])}else{if(arguments[0]){this.masqObj=l.add(l.create(this.getNatDevname(),true))}}if(arguments[0]){f.get("iptables").enabled(true);f.get("iptables.sys").enabled(true);l.enabled(true)}else{var k=true;l.each(true,function(m,n){k=false;return false});if(k){l.enabled(false)}}}else{return l.enabled()&&!!this.masqObj&&this.masqObj.enabled()}},natProtocolEnabled:function(p,l){var o=f.get("system.modules.blacklist"),n="ip_.*_"+p,m=o.find({expr:n});if(l!=undefined){if(!m.length){if(!l){m.push(o.add(o.create(n,true)))}}else{m[0].enabled(!l)}if(!l){o.enabled(true)}else{var k=true;o.each(true,function(q,r){k=false;return false});if(k){o.enabled(false)}}}return !(o.enabled()&&m.length&&m[0].enabled())},getDhcpServer:function(){var n=f.get("dhcpd"),k=f.get("dhcprelay"),o=f.get("dhcprelay.client"),m=f.get("dhcprelay.server"),p=n.find({devname:j.devname}),l=o.find({devname:j.devname});this.dhcpd=n;this.dhcpRelay=k;this.dhcpRelayClient=o;this.dhcpRelayServer=m;if(p!=undefined&&p.length){this.dhcpdObj=p[0]}if(l!=undefined&&l.length){this.dhcpRelayClientObj=l[0]}if(n.enabled()&&this.dhcpdObj&&this.dhcpdObj.enabled()){return"Enabled"}else{if(k.enabled()&&this.dhcpRelayClientObj&&this.dhcpRelayClientObj.enabled()){this.dhcpRelayServerObj=m.objs[this.dhcpRelayClientObj.getIdx()];return"Relay"}else{return"Disabled"}}},setDhcpServer:function(k){switch(k){case"Disabled":if(this.dhcpdObj){this.dhcpdObj.enabled(false)}if(this.dhcpRelayClientObj){this.dhcpRelayClientObj.enabled(false)}if(this.dhcpRelayServerObj){this.dhcpRelayServerObj.enabled(false)}break;case"Enabled":this.dhcpd.enabled(true);if(this.dhcpRelayClientObj){this.dhcpRelayClientObj.enabled(false)}if(this.dhcpRelayServerObj){this.dhcpRelayServerObj.enabled(false)}if(this.dhcpdObj==undefined){this.dhcpdObj=this.dhcpd.create(j.devname,true);this.dhcpd.add(this.dhcpdObj)}else{this.dhcpdObj.enabled(true)}break;case"Relay":if(this.dhcpdObj){this.dhcpdObj.enabled(false)}this.dhcpRelay.enabled(true);if(this.dhcpRelayClientObj==undefined){this.dhcpRelayClientObj=this.dhcpRelayClient.create(j.devname,true);this.dhcpRelayClient.add(this.dhcpRelayClientObj);this.dhcpRelayServerObj=this.dhcpRelayServer.create("",true);this.dhcpRelayServer.objs[this.dhcpRelayClientObj.getIdx()]=this.dhcpRelayServerObj}else{this.dhcpRelayClientObj.enabled(true);this.dhcpRelayServerObj.enabled(true)}break}},getDhcpdAttr:function(l,m,p,o){if(this.dhcpdObj&&this.dhcpdObj[l]&&!m){return this.dhcpdObj[l]}else{p=p||j.ip;o=o||j.netmask;var k=ipSubnetCalc.calculateIpRange(p,o);var n={start:k.rangeStart,end:k.rangeEnd,netmask:k.netmask,lease_time:"600",dnsproxy:"enabled"};if(this.dhcpdObj){this.dhcpdObj.start=k.rangeStart;this.dhcpdObj.end=k.rangeEnd;this.dhcpdObj.netmask=k.netmask}return n[l]}},getDhcp6Server:function(){var l=f.get("dhcp6d"),k=l.find({devname:j.devname});this.dhcp6d=l;if(k!==undefined&&k.length){this.dhcp6dObj=k[0]}if(l.enabled()&&this.dhcp6dObj&&this.dhcp6dObj.enabled()){return this.dhcp6dObj.stateful&&this.dhcp6dObj.stateful.enabled()?"Stateful":"Stateless"}else{return"Disabled"}},setDhcp6Server:function(k){switch(k){case"Disabled":if(this.dhcp6dObj){this.dhcp6dObj.enabled(false)}break;case"Stateless":this.dhcp6d.enabled(true);if(this.dhcp6dObj===undefined){this.dhcp6dObj=this.dhcp6d.create(j.devname,true);this.dhcp6d.add(this.dhcp6dObj)}else{this.dhcp6dObj.enabled(true)}this.dhcp6dObj.stateless.enabled(true);this.dhcp6dObj.stateful.enabled(false);break;case"Stateful":this.dhcp6d.enabled(true);if(this.dhcp6dObj===undefined){this.dhcp6dObj=this.dhcp6d.create(j.devname,true);this.dhcp6d.add(this.dhcp6dObj)}else{this.dhcp6dObj.enabled(true)}this.dhcp6dObj.stateless.enabled(false);this.dhcp6dObj.stateful.enabled(true);break}},dmzEnabled:function(){var l=f.get("iptables.sys.dmz");if(!this.dmzObj){this.dmzObj=l.findByDevname(this.getNatDevname())}if(arguments[0]!==undefined){if(this.dmzObj){this.dmzObj.enabled(arguments[0])}else{if(arguments[0]){this.dmzObj=l.add(l.create(this.getNatDevname(),true))}}if(arguments[0]){f.get("iptables").enabled(true);f.get("iptables.sys").enabled(true);l.enabled(true)}else{var k=true;l.each(true,function(n,m){k=false;return false});if(k){l.enabled(false)}}}else{return l.enabled()&&!!this.dmzObj&&this.dmzObj.enabled()}},dmzMgmtPortsEnabled:function(){if(arguments[0]!==undefined){var k=this.dmzObj.except;k.objs=[];k.enabled(arguments[0]);if(arguments[0]){k.add(k.create(8,"ICMP",true));k.add(k.create(9,"UDP",true));k.add(k.create(f.airview&&f.airview.tcp_port?f.airview.tcp_port:18888,"TCP",true));if(f.httpd&&f.httpd.enabled()){k.add(k.create(f.httpd.port?f.httpd.port:80,"TCP",true))}if(!f.sshd||f.sshd.enabled()){k.add(k.create(f.sshd.port?f.sshd.port:22,"TCP",true))}if(f.httpd&&f.httpd.https&&f.httpd.https.enabled()){k.add(k.create(f.httpd.https.port?f.httpd.https.port:443,"TCP",true))}if(f.telnetd&&f.telnetd.enabled()){k.add(k.create(f.telnetd.port?f.telnetd.port:23,"TCP",true))}if(f.snmp&&f.snmp.enabled()){k.add(k.create(161,"UDP",true))}if(!f.discovery||f.discovery.enabled()){k.add(k.create(10001,"UDP",true))}}}else{if(!this.dmzObj||!this.dmzObj.except){return true}else{return(this.dmzObj.except.enabled()&&this.dmzObj.except.find({status:"enabled"}))}}},blockMgmt:function(){var k=f.get("iptables.sys.mgmt");if(!this.mgmtObj){this.mgmtObj=k.findByDevname(this.getNatDevname())}if(arguments[0]!==undefined){if(this.mgmtObj){this.mgmtObj.enabled(arguments[0])}else{if(arguments[0]){this.mgmtObj=k.add(k.create(this.getNatDevname(),true))}}if(arguments[0]){f.get("iptables").enabled(true);f.get("iptables.sys").enabled(true);k.enabled(true)}else{var l=true;k.each(true,function(n,m){l=false;return false});if(l){k.enabled(false)}}}else{return k.enabled()&&!!this.mgmtObj&&this.mgmtObj.enabled()}},upnpdEnabled:function(){var m=f.get("upnpd"),l=f.get("upnpd.listening"),n=l.find({ip:this.netconfObj.ip}),k=null;if(n.length){k=n[0]}return m.enabled()&&k&&k.enabled()},upnpdEnable:function(k){var m=f.get("upnpd"),l=f.get("upnpd.listening"),n=l.find({ip:this.netconfObj.ip});if(n.length){l.remove(n[0])}if(k){l.add(l.create(this.netconfObj.ip,this.netconfObj.netmask,k))}m.enabled(l.find({status:"enabled"}).length>0)},ip6Enabled:function(){var k=this.netconfObj.ip6;if(k&&k.enabled()){return true}return false},ip6Enable:function(l){var k=this.netconfObj.ip6;if(l||k.status=="enabled"){k.enabled(l)}if(!l){if(this.dhcp6cObj){f.get("dhcp6c").remove(this.dhcp6cObj);delete this.dhcp6cObj}if(this.dhcp6dObj){f.get("dhcp6d").remove(this.dhcp6dObj);delete this.dhcp6cObj}}},getIp6Addr:function(){var k=this.netconfObj.ip6,l=k.objs[0];return l?l.addr:""},getIp6Netmask:function(){var k=this.netconfObj.ip6,l=k.objs[0];return l?l.netmask:"64"},setIp6:function(n,m){var k=this.netconfObj.ip6,l=k.objs[0];if(!l){l=k.add(k.create(n,m,true))}else{l.addr=n;l.netmask=m;l.enabled(true)}}}},i={lan:{},interfaces:[],freeIfc:[],isBridge:f.netmode=="bridge",removeNonExistingIfc:function(){var l=["vlan","dhcpc","dhcpd","dhcprelay.server","dhcpcrelay.client","dnsmasq","ebtables.sys.arpnat","ebtables.sys.eap","ebtables.sys.vlan","iptables.sys.portfw","iptables.sys.dmz","iptables.sys.mgmt","iptables.sys.masq","netconf","ppp","qos.uplink","qos.downlink","radvd","tshaper"],k=Array.prototype.slice.call(this.interfaces,0),j=function(m){return $.inArray(m.devname,k)!=-1};if(f.ppp&&f.ppp.objs.length&&f.ppp.objs[0].enabled()){k.push("ppp+")}$.each(l,function(m,o){var n=f.get(o,false);if(n){n.objs=n.grep(j)}});if(f.bridge){f.bridge.each(function(m,n){if(n.port){n.port.objs=n.port.grep(j)}})}$.each(["ebtables","iptables","ip6tables"],function(n,o){var m=f.get(o,false);if(m){m.objs=m.grep(function(r){var q=r.cmd.split(" "),p=$.inArray("-i",q);if(p!=-1){return $.inArray(q[p+1],k)!=-1}else{return true}})}})},removeDuplicates:function(){var j=["dhcpc","dhcpd"];$.each(j,function(l,o){var n=f.get(o,false);if(n&&n.objs&&n.objs.length>1){var m=[],k=[];n.each(function(p,q){if($.inArray(q.devname,m)==-1){m.push(q.devname);k.push(q)}});n.objs=k}})},addIfc:function(k,l){var n=f.netconf,m=n.findByDevname(k);if(!m){var j=n.create(k,"");$.extend(j,l);n.add(j)}else{if(!m.enabled()){m.enabled(true)}}this.interfaces.push(k);this.interfaces.sort();this.trigger("ifcAdded",k);this.unuseIfc(k)},removeIfc:function(j){var l=f.netconf,k=l.findByDevname(j);if(k){var m=$.inArray(j,this.interfaces);if(k.role=="mlan"||k.role=="wan"){k.enabled(false)}else{l.remove(k)}if(m!=-1){this.interfaces.splice(m,1)}this.useIfc(j);this.trigger("ifcRemoved",j)}},addVlan:function(j){var k=f.get("vlan");k.enabled(true);k.add(j);var l=j.getFullDevname();this.addIfc(l,{mtu:g_net.getMaxMtu(l)})},removeVlan:function(j){f.vlan.remove(j);this.removeIfc(j.getFullDevname())},addBridge:function(){var j=f.bridge.add();this.addIfc(j.devname);return j},removeBridge:function(j){var l=j.getPorts(),k=this;$.each(l,function(m,n){k.removeBridgePort(j,n)});f.bridge.remove(j);this.removeIfc(j.devname)},availableIfcsForBridgePors:function(){var k=f.bridge.getPorts(),j=!this.isBridge&&this.wan.enabled()?this.wan.getDevname():"",l=this.mlan.enabled()?this.mlan.getDevname():"";return $.grep(this.freeIfc,function(m){return m.indexOf("br")!=0&&$.inArray(m,k)==-1&&m!=j&&m!=l})},addBridgePort:function(n,r){var j=n.addPort(r);if(j!=null){var l=f.netconf.findByDevname(r);if(l){l.clear()}if(r.indexOf("ath")!=-1){var p=f.get("ebtables.sys.arpnat"),o=p.findByDevname(r),k=r.indexOf(".")==-1;if(o){o.enabled(true)}else{p.add(p.create(r,true))}if(k){var m=f.get("ebtables.sys.eap"),q=m.findByDevname(r);if(q){q.enabled(true)}else{m.add(m.create(r,true))}f.get("ebtables.sys.eap").enabled(true)}}this.useIfc(r,"bridge_port");this.trigger("bridgePortAdded",r);return j}},removeBridgePort:function(k,l){if(l.indexOf("ath")!=-1){var j=f.get("ebtables.sys.arpnat"),n=j.findByDevname(l),m=f.get("ebtables.sys.eap"),o=m.findByDevname(l);if(n){j.remove(n)}if(o){m.remove(o);m.enabled(m.objs.length)}}k.removePort(l);this.unuseIfc(l);this.trigger("bridgePortRemoved",l)},addLan:function(l){var j=f.netconf.findByDevname(l);if(j){var k=c(j);i.lan[l]=k;this.useIfc(l,"lan");return k}},removeLan:function(k){var j=i.lan[k];j.setDhcpServer("Disabled");j.netconfObj.role="";j.netconfObj.clear();delete i.lan[k];this.unuseIfc(k)},setWanIfc:function(k){var j=this.wan.getDevname();if(j!=k){var o=f.netconf.find({devname:j,role:""}),m=f.netconf.find({devname:k,role:""}),l=this.wan.netconfObj.alias;this.wan.setDevname(k);if(m.length){m[0].enabled(false);this.wan.netconfObj.alias=m[0].alias}if(o.length){o[0].enabled(true);o[0].alias=l}else{var p=f.netconf.add(f.netconf.create(j,""));p.alias=l}this.unuseIfc(j);this.useIfc(k);this.trigger("wanIfcChanged",k)}},setMlanIfc:function(l){var j=this.mlan.enabled(),k=this.isBridge||l!=this.wan.getDevname();prevDevname=this.mlan.getDevname();if(j!=k||prevDevname!=l){var p=f.netconf.find({devname:prevDevname,role:""}),m=f.netconf.find({devname:l,role:""}),o=this.mlan.netconfObj.mtu;alias=this.mlan.netconfObj.alias;this.mlan.enabled(k);this.mlan.setDevname(l);if(j&&prevDevname!=l){if(p.length){p[0].enabled(true);p[0].alias=alias;p[0].mtu=o}else{var q=f.netconf.add(f.netconf.create(prevDevname,""));q.alias=alias;q.mtu=o}this.unuseIfc(prevDevname)}if(k){if(m.length){m[0].enabled(false);this.mlan.netconfObj.alias=m[0].alias;this.mlan.netconfObj.mtu=m[0].mtu}this.useIfc(l)}this.trigger("mlanIfcChanged",l)}return k},swapWanLanIfcs:function(k){var j=this.wan.getDevname();if(k in g_net.lan){var l=g_net.lan[k];g_net.wan.setDevname(k);l.setDevname(j);delete g_net.lan[k];g_net.lan[j]=l}this.trigger("wanIfcChanged",k)},useIfc:function(k,m){var l=$.inArray(k,this.freeIfc);if(l!=-1){if(m){var j=f.netconf.find({devname:k,role:""});if(j.length){j[0].role=m}}this.freeIfc.splice(l,1);this.trigger("ifcUsed",k)}},unuseIfc:function(k){var j=f.netconf.find({devname:k});$.each(j,function(m,l){if(l.role!="mlan"&&l.role!="wan"){l.role=""}});this.freeIfc.push(k);this.freeIfc.sort();this.trigger("ifcUnused",k)},enableIfc:function(l,k){var j=f.netconf.findByDevname(l);if(j&&j.enabled()!=k){var m=$.inArray(l,this.freeIfc);j.enabled(k);this.trigger(k?"ifcEnabled":"ifcDisabled",l)}},getIpdhcpReserv:function(){var j=[];f.get("dhcpd").each(true,function(k,l){if(l.dhcpreserv){l.dhcpreserv.each(function(m,n){j.push({devname:l.devname,dhcpreservObjRef:n})})}});return j},getIpAliases:function(){var j=[];f.netconf.each(true,function(l,k){if(k.alias){k.alias.each(function(m,n){j.push({devname:k.devname,aliasObjRef:n})})}});return j},getNetworkConfig:function(m){if(m=="router"){var n=g_network.ethcount>1;var l,j;if(g_network.apmode){l="ath0";j=n?"br0":"eth0"}else{l=n?"br0":"eth0";j="ath0"}var k=n?"router_with_bridge":"router_no_bridge";var o=b.net.defaultCfg[k];o=o.replace(/LAN/g,l);o=o.replace(/WAN/g,j);return b.cfg.parse(o)}else{return b.cfg.parse(b.net.defaultCfg[m])}},switchNetmode:function(l){var k=["bridge","dhcpc","dhcpd","dhcprelay","dnsmasq","dhcp6c","dhcp6d","ebtables","igmpproxy","iptables","ip6tables","netconf","ppp","resolv.nameserver","route","route6","tshaper"],j=$.extend({},f);$.each(k,function(m,n){if(j[n]){delete j[n]}});$.extend(j,this.getNetworkConfig(l));return j},recreateEbtableSysVlan:function(){var k=f.bridge.getPorts(),j=f.get("ebtables.sys.vlan");j.objs=[];f.get("vlan").each(function(m,l){if($.inArray(l.getDevname(),k)!=-1){j.add($.extend({},l))}});j.enabled(j.objs.length>0)},enableIfExist:function(k,j){var l=f.get(k,false);if(l){l.enabled(j)}},updateStatuses:function(){var x=f.bridge&&f.bridge.objs.length;this.enableIfExist("bridge",x);this.enableIfExist("ebtables",x);this.enableIfExist("ebtables.sys",x);this.recreateEbtableSysVlan();if(x){if(f.ebtables&&f.ebtables.sys){var m=f.get("radio.1").mode,j=f.get("wireless.1.wds").enabled(),y=f.get("wireless.1.macclone"),p=m.toLowerCase()=="managed",u=p&&!j&&y!="enabled";eap=false;if(p){var t,l,q;if((t=f.get("wpasupplicant",false))&&t.enabled()&&(l=f.get("wpasupplicant.device.1",false))&&l.enabled()&&(q=f.get("wpasupplicant.profile.1.network.1.proto.1",false))&&q.mode!=0){eap=true}}else{var k,w,s;if((k=f.get("aaa",false))&&k.enabled()&&(w=f.get("aaa.1",false))&&w.enabled()&&(s=f.get("aaa.1.wpa",false))&&s.mode!=0){eap=true}}f.get("ebtables.sys.arpnat").enabled(u);f.get("ebtables.sys.eap").enabled(eap)}}else{this.enableIfExist("ebtables",false)}f.get("vlan").each(function(A,z){var C=f.netconf.findByDevname(z.devname,true),B=f.netconf.findByDevname(z.getFullDevname(),true);if(C&&B&&C.mtu<B.mtu){B.mtu=C.mtu-4}});if(!this.isBridge){var n=f.get("upnpd"),v=f.get("iptables"),o=f.get("iptables.sys"),r=f.get("iptables.sys.upnpd");if(n.enabled()){n.devname=this.wan.getNatDevname();v.enabled(true);o.enabled(true);r.enabled(true);r.devname=n.devname}else{r.enabled(false)}}},simpleCfgModeApplicable:function(){var q=true;if(this.getIpAliases().length){q=false}if(q){var m=g_net.isBridge?"ebtables":"iptables",n=f.get(m+".sys.fw",false);if(n&&n.enabled()){q=false}}if(q){var k=f.get("vlan",false),j=k?k.objs.length:0,p=f.get("bridge",false),o=p?p.objs.length:0,l=f.netconf.find({role:"lan"}).length;switch(g_cfg.netmode){case"bridge":if(this.getMgmtVlan()){if(o>2||j>f.getInterfaces(["board"])){q=false}}else{if(o>1||j>0){q=false}}break;case"router":if(o>1||j>0||l!=1){q=false}break;case"soho":if(o>1||j>0||l!=1){q=false}break}}return q},advancedCfgMode:function(){var j="gui.network.advanced",l=f.get(j,false),k=false;if(l){k=l.enabled()}if(!k&&!this.simpleCfgModeApplicable()){k=true}return k},setAdvancedCfgMode:function(k){var j="gui.network.advanced";f.get(j).enabled(k)},getMgmtVlan:function(){var n=undefined,j=f.bridge.findByDevname("br1"),k=f.get("vlan",false);if(j&&k){var m=j.getPorts();if(m.length==f.getInterfaces(["board"]).length&&k.isVlan(m[0])){n=k.getId(m[0]);for(var l=1;l<m.length;l++){if(n!=k.getId(m[l])){n=undefined;break}}}}return n},setMgmtVlan:function(o){if(o&&!f.vlan.create("eth0",o,"").valid()){return}var k=f.bridge.findByDevname("br1");if(k){var n=n=k.getPorts();this.setMlanIfc("br0");this.removeBridge(k);for(var m=0;m<n.length;m++){this.removeVlan(f.vlan.findByFullDevname(n[m]))}}if(o){var n=f.getInterfaces(["board"]),l=f.get("vlan");k=this.addBridge();for(var m=0;m<n.length;m++){var j=l.create(n[m],o,"For Management",true);this.addVlan(j);this.addBridgePort(k,j.getFullDevname())}}this.setMlanIfc(o?"br1":"br0")},DEFAULT_MTU:1500,DEFAULT_MAX_MTU:1524,DEFAULT_ATH_MAX_MTU:2024,getPhyMtu:function(l){phyMtu=this.DEFAULT_MAX_MTU;if(l.indexOf("eth")==0){var j=parseInt(l.substr(3))+1;var k=g_board.get("board.phy."+j,false);if(k){phyMtu=k.maxmtu}}else{if(l.indexOf("ath")==0){phyMtu=this.DEFAULT_ATH_MAX_MTU}}return phyMtu},getMtu:function(j){var k=f.netconf.findByDevname(j,true);return parseInt(k?k.mtu:this.DEFAULT_MTU)},getMaxMtu:function(n){var p=this.DEFAULT_MAX_MTU;var l=f.get("vlan");if(n.indexOf("eth")==0||n.indexOf("ath")==0){p=!l.isVlan(n)?this.getPhyMtu(n):(this.getMtu(l.getParent(n))>this.getPhyMtu(n)-4?this.getPhyMtu(n)-4:this.getMtu(l.getParent(n)))}else{var k=f.bridge.findByDevname(n);if(k){var q=k.getPorts();for(var o=0;o<q.length;o++){var j=this.getMtu(q[o]);if(l.isVlan(q[o])&&this.getMaxMtu(q[o])<j){j=this.getMaxMtu(q[o])}if(o==0||j<p){p=j}}}}return p},getWanMaxMtu:function(j){return g_cfg.netconf.findByDevname(j,true).mtu-8},setMtu:function(j,n,o){var l=function k(r){var q=f.get("vlan"),p=f.netconf.findByDevname(r);if(q.isVlan(r)&&!o){k(q.getParent(r))}if(p){p.mtu=n}};l(j);if(j.indexOf("br")==0){var m=f.bridge.findByDevname(j,true);if(m){m.port.each(true,function(p,q){l(q.getDevname())})}}}},d=f.bridge?f.bridge.getPorts():[];$.extend(i,b.core.events);i.interfaces=f.getInterfaces(["board","bridge","vlan"]);i.removeNonExistingIfc();i.removeDuplicates();$.each(i.interfaces,function(k,l){var j=f.netconf.find({devname:l}),n=$.inArray(l,d)!=-1,m=true;if(j.length){$.each(j,function(p,o){var q=o.role;if(o.enabled()){if(m){switch(q){case"wan":if(i.isBridge){o.enabled(false)}else{m=false}break;case"mlan":m=false;break;case"lan":if(i.isBridge){if(n){o.role="bridge_port";m=false}else{o.role=""}}else{m=false}break;case"bridge_port":if(n){m=false}else{o.role=""}break;default:if(n){o.role="bridge_port";m=false}else{o.role=""}break}}else{f.netconf.remove(o)}}else{if(q!="wan"&&q!="mlan"){o.role=""}}});if(m&&n){f.netconf.add(f.netconf.create(l,"bridge_port"))}}else{f.netconf.add(f.netconf.create(l,n?"bridge_port":""))}if(m){i.freeIfc.push(l)}});f.netconf.each(function(k,j){var l=j.role;if(l==="wan"||l==="mlan"){if(i[l]===undefined){i[l]=c(j)}else{j.enabled(false)}}else{if(l==="lan"){i[l][j.getDevname()]=c(j)}}});if(i.wan===undefined&&!i.isBridge){var e="eth0";i.wan=c(f.netconf.add(f.netconf.create(e,"wan")))}if(i.mlan===undefined){var h=i.isBridge?"br0":i.wan.getDevname();if(i.isBridge){var g=f.bridge.getInterfaces();if(!(h in g)){if(g.length){h=g[0]}else{h="eth0"}}}i.mlan=c(f.netconf.add(f.netconf.create(h,"mlan")));if(!i.isBridge){i.mlan.enabled(false)}}if(f.netmode==="bridge"){f.ebtables.enabled(true)}return i};a.defaultCfg={bridge:"netmode=bridge\n\nbridge.status=enabled\nbridge.1.devname=br0\nbridge.1.fd=1\nbridge.1.port.1.devname=eth0\nbridge.1.port.2.devname=ath0\nbridge.1.port.3.devname=eth1\n\nnetconf.status=enabled\nnetconf.1.status=enabled\nnetconf.1.devname=eth0\nnetconf.1.ip=0.0.0.0\nnetconf.1.netmask=255.255.255.0\nnetconf.1.up=enabled\nnetconf.1.promisc=enabled\n\nnetconf.2.status=enabled\nnetconf.2.devname=ath0\nnetconf.2.ip=0.0.0.0\nnetconf.2.netmask=255.255.255.0\nnetconf.2.up=enabled\nnetconf.2.promisc=enabled\nnetconf.2.allmulti=enabled\n\nnetconf.3.status=enabled\nnetconf.3.devname=br0\nnetconf.3.ip=192.168.1.20\nnetconf.3.netmask=255.255.255.0\nnetconf.3.up=enabled\nnetconf.3.role=mlan\n\nnetconf.4.status=enabled\nnetconf.4.devname=eth1\nnetconf.4.ip=0.0.0.0\nnetconf.4.netmask=255.255.255.0\nnetconf.4.up=enabled\nnetconf.4.promisc=enabled\n\nroute.status=enabled\nroute.1.status=enabled\nroute.1.devname=br0\nroute.1.gateway=192.168.1.1\nroute.1.ip=0.0.0.0\nroute.1.netmask=0\n\nebtables.status=enabled\nebtables.sys.status=enabled\n\nebtables.sys.arpnat.status=disabled\nebtables.sys.arpnat.1.status=enabled\nebtables.sys.arpnat.1.devname=ath0\n\nebtables.sys.eap.status=disabled\nebtables.sys.eap.1.status=enabled\nebtables.sys.eap.1.devname=ath0\n",router_no_bridge:"netmode=router\n\nnetconf.status=enabled\nnetconf.1.status=enabled\nnetconf.1.devname=WAN\nnetconf.1.ip=0.0.0.0\nnetconf.1.netmask=255.255.255.0\nnetconf.1.promisc=enabled\nnetconf.1.up=enabled\nnetconf.1.role=wan\n\nnetconf.2.status=enabled\nnetconf.2.devname=LAN\nnetconf.2.ip=192.168.1.1\nnetconf.2.netmask=255.255.255.0\nnetconf.2.up=enabled\nnetconf.2.promisc=enabled\nnetconf.2.role=lan\n\nbridge.status=disabled\n\ndhcpc.status=enabled\ndhcpc.1.status=enabled\ndhcpc.1.devname=WAN\ndhcpc.1.fallback=192.168.10.1\n",router_with_bridge:"netmode=router\n\nnetconf.status=enabled\nnetconf.1.status=enabled\nnetconf.1.devname=WAN\nnetconf.1.ip=0.0.0.0\nnetconf.1.netmask=255.255.255.0\nnetconf.1.promisc=enabled\nnetconf.1.up=enabled\nnetconf.1.role=wan\n\nnetconf.2.status=enabled\nnetconf.2.devname=LAN\nnetconf.2.ip=192.168.1.1\nnetconf.2.netmask=255.255.255.0\nnetconf.2.up=enabled\nnetconf.2.promisc=enabled\nnetconf.2.role=lan\n\nnetconf.3.status=enabled\nnetconf.3.devname=eth0\nnetconf.3.ip=0.0.0.0\nnetconf.3.netmask=255.255.255.0\nnetconf.3.up=enabled\nnetconf.3.promisc=enabled\nnetconf.3.role=bridge_port\n\nnetconf.4.status=enabled\nnetconf.4.devname=eth1\nnetconf.4.ip=0.0.0.0\nnetconf.4.netmask=255.255.255.0\nnetconf.4.up=enabled\nnetconf.4.promisc=enabled\nnetconf.4.role=bridge_port\n\ndhcpc.status=enabled\ndhcpc.1.status=enabled\ndhcpc.1.devname=WAN\ndhcpc.1.fallback=192.168.10.1\n\nbridge.status=enabled\nbridge.1.devname=br0\nbridge.1.fd=1\nbridge.1.port.1.devname=eth0\nbridge.1.port.2.devname=eth1\n",soho:"netmode=soho\n\nbridge.status=enabled\nbridge.1.devname=br0\nbridge.1.fd=1\nbridge.1.port.1.devname=ath0\nbridge.1.port.2.devname=eth1\n\nnetconf.status=enabled\nnetconf.1.status=enabled\nnetconf.1.devname=eth0\nnetconf.1.ip=0.0.0.0\nnetconf.1.netmask=255.255.255.0\nnetconf.1.promisc=enabled\nnetconf.1.up=enabled\nnetconf.1.role=wan\n\nnetconf.2.status=enabled\nnetconf.2.devname=ath0\nnetconf.2.ip=0.0.0.0\nnetconf.2.netmask=255.255.255.0\nnetconf.2.up=enabled\nnetconf.2.promisc=enabled\n\nnetconf.3.status=enabled\nnetconf.3.devname=br0\nnetconf.3.ip=192.168.1.1\nnetconf.3.netmask=255.255.255.0\nnetconf.3.up=enabled\nnetconf.3.role=lan\n\nnetconf.4.devname=eth1\nnetconf.4.ip=0.0.0.0\nnetconf.4.netmask=255.255.255.0\nnetconf.4.up=enabled\n\ndhcpd.status=enabled\ndhcpd.1.status=enabled\ndhcpd.1.devname=br0\ndhcpd.1.dnsproxy=enabled\ndhcpd.1.lease_time=600\ndhcpd.1.netmask=255.255.255.0\ndhcpd.1.start=192.168.1.2\ndhcpd.1.end=192.168.1.254\n\ndhcpc.status=enabled\ndhcpc.1.status=enabled\ndhcpc.1.devname=eth0\ndhcpc.1.fallback=192.168.10.1\n\niptables.status=enabled\niptables.sys.status=enabled\niptables.sys.masq.status=enabled\niptables.sys.masq.1.status=enabled\niptables.sys.masq.1.devname=eth0\n\nebtables.status=enabled\nebtables.sys.status=enabled\n\nebtables.sys.arpnat.status=disabled\nebtables.sys.arpnat.1.status=enabled\nebtables.sys.arpnat.1.devname=ath0\n\nebtables.sys.eap.status=disabled\nebtables.sys.eap.1.status=enabled\nebtables.sys.eap.1.devname=ath0\n","3g":"netmode=3g\n\nbridge.status=enabled\nbridge.1.devname=br0\nbridge.1.fd=1\nbridge.1.port.1.devname=ath0\nbridge.1.port.2.devname=eth0\nbridge.1.port.3.devname=eth1\n\nnetconf.status=enabled\nnetconf.1.status=enabled\nnetconf.1.devname=eth0\nnetconf.1.ip=0.0.0.0\nnetconf.1.netmask=255.255.255.0\nnetconf.1.promisc=enabled\nnetconf.1.up=enabled\n\nnetconf.2.status=enabled\nnetconf.2.devname=ath0\nnetconf.2.ip=0.0.0.0\nnetconf.2.netmask=255.255.255.0\nnetconf.2.up=enabled\nnetconf.2.promisc=enabled\n\nnetconf.3.status=enabled\nnetconf.3.devname=br0\nnetconf.3.ip=192.168.1.1\nnetconf.3.netmask=255.255.255.0\nnetconf.3.up=enabled\nnetconf.3.role=lan\n\nnetconf.4.devname=eth1\nnetconf.4.ip=0.0.0.0\nnetconf.4.netmask=255.255.255.0\nnetconf.4.up=enabled\n\ndhcpd.status=enabled\ndhcpd.1.status=enabled\ndhcpd.1.devname=br0\ndhcpd.1.dnsproxy=enabled\ndhcpd.1.lease_time=600\ndhcpd.1.netmask=255.255.255.0\ndhcpd.1.start=192.168.1.2\ndhcpd.1.end=192.168.1.254\n\niptables.status=enabled\niptables.sys.status=enabled\niptables.sys.masq.status=enabled\niptables.sys.masq.1.status=enabled\niptables.sys.masq.1.devname=ppp+\n\nebtables.status=enabled\nebtables.sys.status=enabled\n\nebtables.sys.arpnat.status=disabled\nebtables.sys.arpnat.1.status=enabled\nebtables.sys.arpnat.1.devname=ath0\n\nebtables.sys.eap.status=disabled\nebtables.sys.eap.1.status=enabled\nebtables.sys.eap.1.devname=ath0\n\n3g.status=enabled\n3g.1.status=enabled\n"}})();